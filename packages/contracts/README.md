# @zk-id/contracts

**On-chain verification for zk-id zero-knowledge proofs**

This package provides Solidity smart contracts for verifying zk-id proofs on Ethereum and EVM-compatible blockchains.

## Overview

The contracts enable on-chain verification of zero-knowledge proofs for age and nationality claims, unlocking use cases like:

- **DeFi KYC**: Age-gated access to regulated DeFi protocols
- **DAO Voting**: Age or nationality requirements for governance participation
- **NFT Minting**: Age-restricted NFT collections
- **Token Transfers**: Compliant token transfers with on-chain age verification
- **Smart Contract Access Control**: Age or nationality-based permissions

## Contracts

### Core Verifiers

Auto-generated Groth16 verifiers for each circuit:

- `AgeVerifier.sol` - Verifies age proofs (age >= minAge)
- `NationalityVerifier.sol` - Verifies nationality proofs
- `AgeVerifierSigned.sol` - Verifies age proofs with issuer signature in-circuit
- `NationalityVerifierSigned.sol` - Verifies nationality proofs with issuer signature
- `AgeVerifierRevocable.sol` - Verifies age proofs with Merkle revocation check

### High-Level API

- `ZkIdVerifier.sol` - Wrapper contract with semantic function names and events

## Installation

```bash
npm install @zk-id/contracts
```

## Usage

### Deploy Contracts

```bash
npx hardhat run scripts/deploy.ts --network <network>
```

Supported networks: localhost, sepolia, mainnet, polygon, arbitrum, optimism

### Verify Age On-Chain

```solidity
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.24;

import "@zk-id/contracts/contracts/ZkIdVerifier.sol";

contract AgeGatedDAO {
    ZkIdVerifier public zkIdVerifier;

    constructor(address _zkIdVerifier) {
        zkIdVerifier = ZkIdVerifier(_zkIdVerifier);
    }

    function vote(
        uint256[2] calldata pA,
        uint256[2][2] calldata pB,
        uint256[2] calldata pC,
        uint256 currentYear,
        uint256 minAge,
        uint256 credentialHash,
        uint256 nonce,
        uint256 requestTimestamp
    ) external {
        require(
            zkIdVerifier.verifyAgeProof(
                pA, pB, pC,
                currentYear,
                minAge,
                credentialHash,
                nonce,
                requestTimestamp
            ),
            "Age verification failed"
        );

        // User has proven they meet the minimum age requirement
        // Proceed with voting logic...
    }
}
```

### Verify Nationality On-Chain

```solidity
function transferToUSCitizen(
    address to,
    uint256 amount,
    uint256[2] calldata pA,
    uint256[2][2] calldata pB,
    uint256[2] calldata pC,
    uint256 nationalityCode,
    uint256 credentialHash,
    uint256 nonce,
    uint256 requestTimestamp
) external {
    require(nationalityCode == 840, "Must be US citizen");

    require(
        zkIdVerifier.verifyNationalityProof(
            pA, pB, pC,
            nationalityCode,
            credentialHash,
            nonce,
            requestTimestamp
        ),
        "Nationality verification failed"
    );

    // Transfer tokens to verified US citizen
    _transfer(msg.sender, to, amount);
}
```

## Public Signals

### Age Proof

Public signals for `verifyAgeProof` (in order):

1. `currentYear` - Current year for age calculation (e.g., 2026)
2. `minAge` - Minimum required age (e.g., 18 or 21)
3. `credentialHash` - Poseidon hash of the credential (binding)
4. `nonce` - Replay protection nonce
5. `requestTimestamp` - Unix timestamp of the proof request

### Nationality Proof

Public signals for `verifyNationalityProof` (in order):

1. `nationalityCode` - ISO 3166-1 numeric code (e.g., 840 for USA)
2. `credentialHash` - Poseidon hash of the credential
3. `nonce` - Replay protection nonce
4. `requestTimestamp` - Unix timestamp of the proof request

## Gas Costs

Approximate gas costs for proof verification (on Ethereum mainnet):

- `verifyAgeProof`: ~250,000 gas
- `verifyNationalityProof`: ~200,000 gas
- `verifyAgeProofSigned`: ~400,000 gas (includes signature verification)
- `verifyAgeProofRevocable`: ~300,000 gas (includes Merkle proof)

Gas costs vary by network and EVM version. Use `hardhat test` for accurate estimates.

## Development

### Compile Contracts

```bash
npm run build
```

### Run Tests

```bash
npm test
```

### Deploy to Localhost

```bash
# Start a local Hardhat node
npx hardhat node

# Deploy to localhost (in another terminal)
npm run deploy
```

## Security

- All verifier contracts are auto-generated by snarkjs from trusted zkeys
- Verification keys are embedded as constants in the contract bytecode
- Proof verification uses the standard Groth16 pairing check on BN128
- No external calls or state modifications during verification (except events)

**Production Checklist:**

- [ ] Use production Powers of Tau ceremony (not test)
- [ ] Verify contract source code on Etherscan
- [ ] Audit smart contract integration logic
- [ ] Implement nonce replay protection in your application
- [ ] Validate timestamp freshness before accepting proofs
- [ ] Consider gas optimization for high-volume use cases

## Supported Networks

- Ethereum Mainnet
- Polygon (MATIC)
- Arbitrum
- Optimism
- Any EVM-compatible chain with BN128 precompiles (EIP-196/197)

## License

Apache-2.0

## Related Packages

- `@zk-id/core` - Generate and verify proofs off-chain
- `@zk-id/sdk` - Server-side verification SDK
- `@zk-id/issuer` - Credential issuance
- `@zk-id/circuits` - Circom ZK circuits

## Learn More

- [Architecture Documentation](../../docs/ARCHITECTURE.md)
- [Protocol Specification](../../docs/PROTOCOL.md)
- [Example: Web Application Demo](../../examples/web-app/)

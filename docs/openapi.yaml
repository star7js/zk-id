openapi: 3.0.3
info:
  title: zk-id Demo API
  version: 0.4.1
  description: |
    Demo REST API for zk-id verification flows.

    This API implements the zk-id protocol version **zk-id/1.0-draft**.
    Protocol version is communicated via the `X-ZkId-Protocol-Version` header.
    Servers may reject incompatible protocol versions with `400`.

    This is a reference schema and may evolve as the protocol matures.
servers:
  - url: http://localhost:3000
paths:
  /api/health:
    get:
      summary: Health check
      parameters:
        - $ref: '#/components/parameters/ProtocolVersionHeader'
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'
          headers:
            X-ZkId-Protocol-Version:
              $ref: '#/components/headers/ProtocolVersion'
        '400':
          description: Incompatible protocol version
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /api/challenge:
    get:
      summary: Get server-issued nonce and timestamp
      parameters:
        - $ref: '#/components/parameters/ProtocolVersionHeader'
      responses:
        '200':
          description: Challenge payload
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Challenge'
          headers:
            X-ZkId-Protocol-Version:
              $ref: '#/components/headers/ProtocolVersion'
        '400':
          description: Incompatible protocol version
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /api/issue-credential:
    post:
      summary: Issue a signed credential (Ed25519)
      parameters:
        - $ref: '#/components/parameters/ProtocolVersionHeader'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [birthYear, nationality]
              properties:
                birthYear:
                  type: integer
                nationality:
                  type: integer
                userId:
                  type: string
      responses:
        '200':
          description: Issued credential
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  message:
                    type: string
                  credential:
                    $ref: '#/components/schemas/SignedCredential'
          headers:
            X-ZkId-Protocol-Version:
              $ref: '#/components/headers/ProtocolVersion'
        '400':
          description: Bad request (including incompatible protocol version)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /api/issue-credential-signed:
    post:
      summary: Issue a credential for signed circuits (BabyJub EdDSA)
      parameters:
        - $ref: '#/components/parameters/ProtocolVersionHeader'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [birthYear, nationality]
              properties:
                birthYear:
                  type: integer
                nationality:
                  type: integer
      responses:
        '200':
          description: Issued circuit credential
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  message:
                    type: string
                  credential:
                    $ref: '#/components/schemas/CircuitSignedCredential'
          headers:
            X-ZkId-Protocol-Version:
              $ref: '#/components/headers/ProtocolVersion'
        '400':
          description: Bad request (including incompatible protocol version)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /api/verify-age:
    post:
      summary: Verify an age proof
      parameters:
        - $ref: '#/components/parameters/ProtocolVersionHeader'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ProofResponse'
      responses:
        '200':
          description: Verification result
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/VerificationResult'
          headers:
            X-ZkId-Protocol-Version:
              $ref: '#/components/headers/ProtocolVersion'
        '400':
          description: Bad request (including incompatible protocol version)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /api/verify-nationality:
    post:
      summary: Verify a nationality proof
      parameters:
        - $ref: '#/components/parameters/ProtocolVersionHeader'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ProofResponse'
      responses:
        '200':
          description: Verification result
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/VerificationResult'
          headers:
            X-ZkId-Protocol-Version:
              $ref: '#/components/headers/ProtocolVersion'
        '400':
          description: Bad request (including incompatible protocol version)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /api/demo/verify-age:
    post:
      summary: Demo - generate and verify age proof server-side
      parameters:
        - $ref: '#/components/parameters/ProtocolVersionHeader'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/DemoAgeRequest'
      responses:
        '200':
          description: Demo response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DemoVerificationResponse'
          headers:
            X-ZkId-Protocol-Version:
              $ref: '#/components/headers/ProtocolVersion'
        '400':
          description: Bad request (including incompatible protocol version)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Credential not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /api/demo/verify-nationality:
    post:
      summary: Demo - generate and verify nationality proof server-side
      parameters:
        - $ref: '#/components/parameters/ProtocolVersionHeader'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/DemoNationalityRequest'
      responses:
        '200':
          description: Demo response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DemoVerificationResponse'
          headers:
            X-ZkId-Protocol-Version:
              $ref: '#/components/headers/ProtocolVersion'
        '400':
          description: Bad request (including incompatible protocol version)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Credential not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /api/demo/verify-age-signed:
    post:
      summary: Demo - generate and verify signed age proof
      parameters:
        - $ref: '#/components/parameters/ProtocolVersionHeader'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/DemoAgeRequest'
      responses:
        '200':
          description: Demo response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DemoVerificationResponse'
          headers:
            X-ZkId-Protocol-Version:
              $ref: '#/components/headers/ProtocolVersion'
        '400':
          description: Bad request (including incompatible protocol version)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Credential not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /api/demo/verify-nationality-signed:
    post:
      summary: Demo - generate and verify signed nationality proof
      parameters:
        - $ref: '#/components/parameters/ProtocolVersionHeader'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/DemoNationalityRequest'
      responses:
        '200':
          description: Demo response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DemoVerificationResponse'
          headers:
            X-ZkId-Protocol-Version:
              $ref: '#/components/headers/ProtocolVersion'
        '400':
          description: Bad request (including incompatible protocol version)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Credential not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /api/demo/verify-age-revocable:
    post:
      summary: Demo - generate and verify revocable age proof
      parameters:
        - $ref: '#/components/parameters/ProtocolVersionHeader'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/DemoAgeRequest'
      responses:
        '200':
          description: Demo response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DemoVerificationResponse'
          headers:
            X-ZkId-Protocol-Version:
              $ref: '#/components/headers/ProtocolVersion'
        '400':
          description: Bad request (including incompatible protocol version)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Credential not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /api/revoke-credential:
    post:
      summary: Revoke a credential by ID
      parameters:
        - $ref: '#/components/parameters/ProtocolVersionHeader'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [credentialId]
              properties:
                credentialId:
                  type: string
      responses:
        '200':
          description: Revocation result
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  message:
                    type: string
          headers:
            X-ZkId-Protocol-Version:
              $ref: '#/components/headers/ProtocolVersion'
        '400':
          description: Bad request (including incompatible protocol version)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Credential not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /api/revocation/root:
    get:
      summary: Get current revocation root info with versioning and TTL
      description: |
        Returns the current valid-set Merkle root along with version metadata
        and caching guidance. Clients should cache the response for `ttlSeconds`
        and re-fetch before `expiresAt`. See PROTOCOL.md Â§Revocation Root Distribution.
      parameters:
        - $ref: '#/components/parameters/ProtocolVersionHeader'
      responses:
        '200':
          description: Current revocation root info
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RevocationRootInfo'
          headers:
            X-ZkId-Protocol-Version:
              $ref: '#/components/headers/ProtocolVersion'
            Cache-Control:
              description: Cache guidance based on configured TTL (e.g., "public, max-age=300")
              schema:
                type: string
        '400':
          description: Bad request (including incompatible protocol version)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
components:
  parameters:
    ProtocolVersionHeader:
      name: X-ZkId-Protocol-Version
      in: header
      required: false
      description: Protocol version for compatibility (e.g., "zk-id/1.0-draft")
      schema:
        type: string
  headers:
    ProtocolVersion:
      description: Protocol version (e.g., "zk-id/1.0-draft")
      schema:
        type: string
  schemas:
    HealthResponse:
      type: object
      required: [status, timestamp, issuer, protocolVersion]
      properties:
        status:
          type: string
        timestamp:
          type: string
          format: date-time
        issuer:
          type: string
        protocolVersion:
          type: string
          description: Protocol version (e.g., "zk-id/1.0-draft")
    Challenge:
      type: object
      required: [nonce, requestTimestamp]
      properties:
        nonce:
          type: string
        requestTimestamp:
          type: string
          format: date-time
    RevocationRootInfo:
      type: object
      required: [root, version, updatedAt]
      properties:
        root:
          type: string
          description: Current Merkle root (decimal string)
        version:
          type: integer
          description: Monotonic root version (increments on each tree mutation)
        updatedAt:
          type: string
          format: date-time
          description: ISO 8601 timestamp of last tree mutation
        expiresAt:
          type: string
          format: date-time
          description: ISO 8601 timestamp after which this root should be re-fetched
        ttlSeconds:
          type: integer
          description: Recommended cache lifetime in seconds (default 300)
        source:
          type: string
          description: Identifier for the root source (issuer name, registry URL)
    Credential:
      type: object
      properties:
        id:
          type: string
        birthYear:
          type: integer
        nationality:
          type: integer
        salt:
          type: string
        commitment:
          type: string
        createdAt:
          type: string
          format: date-time
    SignedCredential:
      type: object
      properties:
        credential:
          $ref: '#/components/schemas/Credential'
        issuer:
          type: string
        signature:
          type: string
        issuedAt:
          type: string
          format: date-time
    CircuitSignedCredential:
      type: object
      properties:
        credential:
          $ref: '#/components/schemas/Credential'
        issuer:
          type: string
        issuerPublicKey:
          type: array
          items:
            type: string
        signature:
          type: object
          properties:
            R8:
              type: array
              items:
                type: string
            S:
              type: array
              items:
                type: string
        issuedAt:
          type: string
          format: date-time
    Proof:
      type: object
      properties:
        pi_a:
          type: array
          items:
            type: string
        pi_b:
          type: array
          items:
            type: array
            items:
              type: string
        pi_c:
          type: array
          items:
            type: string
        protocol:
          type: string
        curve:
          type: string
    AgePublicSignals:
      type: object
      properties:
        currentYear:
          type: integer
        minAge:
          type: integer
        credentialHash:
          type: string
        nonce:
          type: string
        requestTimestamp:
          type: integer
    NationalityPublicSignals:
      type: object
      properties:
        targetNationality:
          type: integer
        credentialHash:
          type: string
        nonce:
          type: string
        requestTimestamp:
          type: integer
    AgeProofSignedPublicSignals:
      type: object
      description: Public signals for signed age proofs (includes issuer public key)
      properties:
        currentYear:
          type: integer
        minAge:
          type: integer
        credentialHash:
          type: string
        nonce:
          type: string
        requestTimestamp:
          type: integer
        issuerPublicKey:
          type: array
          items:
            type: string
          description: BabyJub issuer public key coordinates
    NationalityProofSignedPublicSignals:
      type: object
      description: Public signals for signed nationality proofs (includes issuer public key)
      properties:
        targetNationality:
          type: integer
        credentialHash:
          type: string
        nonce:
          type: string
        requestTimestamp:
          type: integer
        issuerPublicKey:
          type: array
          items:
            type: string
          description: BabyJub issuer public key coordinates
    AgeProofRevocablePublicSignals:
      type: object
      description: Public signals for revocable age proofs (includes merkle root)
      properties:
        currentYear:
          type: integer
        minAge:
          type: integer
        credentialHash:
          type: string
        nonce:
          type: string
        requestTimestamp:
          type: integer
        merkleRoot:
          type: string
          description: Merkle root of the valid credentials tree
    ProofResponse:
      type: object
      required: [claimType, proof, nonce, requestTimestamp, signedCredential]
      properties:
        credentialId:
          type: string
        claimType:
          type: string
          enum: [age, nationality, age-revocable]
        proof:
          type: object
          properties:
            proof:
              $ref: '#/components/schemas/Proof'
            publicSignals:
              oneOf:
                - $ref: '#/components/schemas/AgePublicSignals'
                - $ref: '#/components/schemas/NationalityPublicSignals'
                - $ref: '#/components/schemas/AgeProofSignedPublicSignals'
                - $ref: '#/components/schemas/NationalityProofSignedPublicSignals'
                - $ref: '#/components/schemas/AgeProofRevocablePublicSignals'
        signedCredential:
          oneOf:
            - $ref: '#/components/schemas/SignedCredential'
            - $ref: '#/components/schemas/CircuitSignedCredential'
        nonce:
          type: string
        requestTimestamp:
          type: string
          format: date-time
    SignedProofRequest:
      type: object
      description: Request body for verifySignedProof() flow
      required: [claimType, proof, signedCredential, nonce, requestTimestamp]
      properties:
        claimType:
          type: string
          enum: [age, nationality]
        proof:
          type: object
          properties:
            proof:
              $ref: '#/components/schemas/Proof'
            publicSignals:
              oneOf:
                - $ref: '#/components/schemas/AgeProofSignedPublicSignals'
                - $ref: '#/components/schemas/NationalityProofSignedPublicSignals'
        signedCredential:
          $ref: '#/components/schemas/CircuitSignedCredential'
        nonce:
          type: string
        requestTimestamp:
          type: string
          format: date-time
    DemoAgeRequest:
      type: object
      required: [credentialId, minAge]
      properties:
        credentialId:
          type: string
        minAge:
          type: integer
        nonce:
          type: string
        requestTimestamp:
          type: string
          format: date-time
    DemoNationalityRequest:
      type: object
      required: [credentialId, targetNationality]
      properties:
        credentialId:
          type: string
        targetNationality:
          type: integer
        nonce:
          type: string
        requestTimestamp:
          type: string
          format: date-time
    VerificationResult:
      type: object
      required: [verified]
      properties:
        verified:
          type: boolean
        claimType:
          type: string
        minAge:
          type: integer
        targetNationality:
          type: integer
        error:
          type: string
        protocolVersion:
          type: string
          description: Protocol version (e.g., "zk-id/1.0-draft")
    DemoVerificationResponse:
      type: object
      properties:
        verified:
          type: boolean
        message:
          type: string
        error:
          type: string
        privacy:
          type: object
          description: Privacy guarantees of the proof
          properties:
            doesNotRevealBirthYear:
              type: boolean
            doesNotRevealNationality:
              type: boolean
            doesNotRevealCredentialId:
              type: boolean
        proofDetails:
          type: object
          description: Details about the verified proof
          properties:
            claimType:
              type: string
            minAge:
              type: integer
            targetNationality:
              type: integer
            verifiedAt:
              type: string
              format: date-time
        timing:
          type: object
          properties:
            proofGenerationMs:
              type: integer
            verificationMs:
              type: integer
            totalMs:
              type: integer
    ErrorResponse:
      type: object
      required: [error]
      properties:
        error:
          type: string
          description: Error message
        details:
          type: string
          description: Additional error details
        verified:
          type: boolean
          description: Present in verification errors (always false)
    IssuerRecord:
      type: object
      required: [issuer]
      description: Registered issuer record with key, status, and metadata
      properties:
        issuer:
          type: string
          description: Issuer identifier (name or DID)
        status:
          type: string
          enum: [active, revoked, suspended]
          description: Lifecycle status of the issuer
        validFrom:
          type: string
          format: date-time
          description: Key is not valid before this time
        validTo:
          type: string
          format: date-time
          description: Key is not valid after this time
        jurisdiction:
          type: string
          description: ISO 3166-1 alpha-2 jurisdiction code (e.g., "US", "DE")
        policyUrl:
          type: string
          format: uri
          description: URL to issuance/attestation policy document
        auditUrl:
          type: string
          format: uri
          description: URL to external audit report or compliance reference
    # SDK Configuration Schemas (Informational)
    ZkIdServerConfig:
      type: object
      description: SDK server configuration (informational - not an API endpoint)
      properties:
        issuerPrivateKey:
          type: string
        verificationKeys:
          $ref: '#/components/schemas/VerificationKeySet'
        requiredPolicy:
          $ref: '#/components/schemas/RequiredPolicy'
        protocolVersionPolicy:
          type: string
          enum: [strict, warn, off]
          description: Protocol version enforcement policy (default: warn)
        validCredentialTree:
          type: object
          description: Optional valid-credential tree implementation (e.g., PostgresValidCredentialTree)
    VerificationKeySet:
      type: object
      description: Collection of verification keys for different proof types
      properties:
        ageProof:
          $ref: '#/components/schemas/VerificationKey'
        nationalityProof:
          $ref: '#/components/schemas/VerificationKey'
        ageProofSigned:
          $ref: '#/components/schemas/VerificationKey'
        nationalityProofSigned:
          $ref: '#/components/schemas/VerificationKey'
        ageProofRevocable:
          $ref: '#/components/schemas/VerificationKey'
    VerificationKey:
      type: object
      description: ZK-SNARK verification key
      properties:
        protocol:
          type: string
        curve:
          type: string
        nPublic:
          type: integer
        vk_alpha_1:
          type: array
          items:
            type: string
        vk_beta_2:
          type: array
        vk_gamma_2:
          type: array
        vk_delta_2:
          type: array
        vk_alphabeta_12:
          type: array
        IC:
          type: array
    RequiredPolicy:
      type: object
      description: Policy for proof validation requirements
      properties:
        requireNonce:
          type: boolean
        requireTimestamp:
          type: boolean
        maxProofAgeSeconds:
          type: integer
    ProofChallenge:
      type: object
      description: Challenge parameters for proof generation
      properties:
        nonce:
          type: string
        requestTimestamp:
          type: string
          format: date-time
    BatchVerificationResult:
      type: object
      description: Result of batch proof verification
      properties:
        verified:
          type: boolean
        results:
          type: array
          items:
            $ref: '#/components/schemas/VerificationResult'
        errors:
          type: array
          items:
            type: string
